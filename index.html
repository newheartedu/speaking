import React, { useState, useEffect, useRef } from 'react';
import { 
  Heart, Music, Mic, Users, Calendar, ClipboardList, Send, 
  CheckCircle, Sparkles, MessageCircle, Trash2, Edit, 
  X, CheckSquare, AlignLeft, Type, AlertTriangle, Lock, FileText, Printer, Download, LogOut, ChevronLeft
} from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs,
  Timestamp 
} from 'firebase/firestore';

// ==========================================
// TODO: 請在此處填入您自己的 Firebase 設定
// 您可以在 Firebase Console -> Project Settings 找到
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyBn1yMn52lnNWsfqQPNGi2Sm6-ZLdjaljA",
  authDomain: "wedding-4926f.firebaseapp.com",
  projectId: "wedding-4926f",
  storageBucket: "wedding-4926f.firebasestorage.app",
  messagingSenderId: "546290565662",
  appId: "1:546290565662:web:e9d346f2c778e95696a40f",

// 初始化 Firebase (加入錯誤處理，避免設定為空時白畫面)
let app, auth, db;
try {
  // 如果還沒設定 config，這裡會報錯，我們做個簡單的檢查
  if (firebaseConfig.apiKey === "請替換成您的_API_KEY") {
    console.warn("尚未設定 Firebase Config，請在程式碼中填入您的設定。");
  } else {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  }
} catch (error) {
  console.error("Firebase 初始化失敗:", error);
}

const WeddingSurveyForm = () => {
  // 1. 定義初始問卷結構
  const initialSections = [
    {
      id: 'basic',
      title: '基本資訊',
      icon: ClipboardList,
      questions: [
        { id: 'b1', type: 'text', label: '新郎姓名' },
        { id: 'b2', type: 'text', label: '新娘姓名' },
        { id: 'b3', type: 'date', label: '婚禮日期' },
        { id: 'b4', type: 'text', label: '婚禮舉行地點' }
      ]
    },
    {
      id: 'style',
      title: '婚禮風格與氛圍',
      icon: Heart,
      questions: [
        { 
          id: 's1', type: 'checkbox', label: '您希望婚禮的整體氛圍是什麼樣的？(可複選)', 
          options: ['優雅浪漫', '輕鬆幽默', '熱烈熱情', '正式莊重', '其他（請具體描述）'] 
        },
        { 
          id: 's2', type: 'checkbox', label: '您希望主持人的風格是什麼樣的？(可複選)', 
          options: ['輕鬆幽默，讓來賓開心', '正式莊重，尊重儀式感', '活潑熱情，讓氛圍更加熱烈', '輕快、自然，保持輕鬆的氛圍', '其他（請具體描述）'] 
        },
        { 
          id: 's3', type: 'checkbox', label: '婚禮過程中，您希望主持人更多強調哪些方面？(可複選)', 
          options: ['夫妻的愛情故事', '家庭與朋友的祝福', '婚禮儀式的莊重感', '互動遊戲或有趣的環節', '其他（請具體描述）'] 
        },
        { 
          id: 's4', type: 'radio', label: '在婚禮上，您希望主持人如何與來賓互動？', 
          options: ['輕鬆、隨和地與來賓互動', '鼓勵來賓參與某些環節', '保持較少互動，專注於主持', '其他（請具體描述）'] 
        }
      ]
    },
    {
      id: 'story',
      title: '新人的背景與故事',
      icon: Users,
      questions: [
        { id: 'st1', type: 'textarea', label: '新郎與新娘的相識過程是什麼？' },
        { id: 'st2', type: 'textarea', label: '彼此認為最浪漫的事' },
        { id: 'st3', type: 'textarea', label: '交往多久? 工作、平常相處是遠距離嗎？' },
        { id: 'st4', type: 'textarea', label: '這一年來大概多久見一次？' },
        { id: 'st5', type: 'textarea', label: '如何維繫彼此的感情？' },
        { id: 'st6', type: 'textarea', label: '如何確定對方就是對的人？' },
        { id: 'st7', type: 'textarea', label: '用一個狀態形容 對方在自己心中的樣子' },
        { id: 'st8', type: 'textarea', label: '對方為自己做過最浪慢的事' },
        { id: 'st9', type: 'textarea', label: '有沒有特別的家庭成員或朋友，希望在婚禮中被提到或特別感謝？' },
        { id: 'st10', type: 'textarea', label: '您希望在婚禮中有沒有特別的驚喜或互動環節？' },
        { id: 'st11', type: 'textarea', label: '婚禮中是否有特別的元素（例如：文化、家庭傳統、特定歌曲或習俗）您希望強調？' }
      ]
    },
    {
      id: 'flow',
      title: '婚禮儀式與流程',
      icon: Calendar,
      questions: [
        { 
          id: 'f1', type: 'checkbox', label: '婚禮中的主要儀式，您希望強調哪些？(可複選)', 
          options: ['誓言交換', '交換戒指', '第一支舞', '乾杯儀式', '父母感謝', '其他（請具體描述）'] 
        },
        { 
          id: 'f2', type: 'radio', label: '婚禮儀式結束後，您是否希望主持人帶領其他活動（如：晚宴、遊戲、表演等）？', 
          options: ['是', '否', '不確定'] 
        },
        { 
          id: 'f3', type: 'radio', label: '您希望婚禮的流程緊湊還是稍微輕鬆一些？', 
          options: ['緊湊，按時完成每個環節', '輕鬆，給來賓更多自由交流的時間'] 
        }
      ]
    },
    {
      id: 'req',
      title: '婚禮主持的具體要求',
      icon: Mic,
      questions: [
        { 
          id: 'r1', type: 'checkbox', label: '您希望主持人在婚禮中使用哪些語言或語氣？(可複選)', 
          options: ['輕鬆幽默，帶有笑點', '端莊正式，專注於儀式感', '感性、溫馨，注重情感表達', '其他（請具體描述）'] 
        },
        { 
          id: 'r2', type: 'radio', label: '您是否希望主持人提前與您進行一對一的會議，了解婚禮的詳細安排？', 
          options: ['是', '否', '無所謂'] 
        },
        { id: 'r3', type: 'textarea', label: '婚禮中是否有您希望避免的事情？' }
      ]
    },
    {
      id: 'music',
      title: '婚禮的音樂與其他細節',
      icon: Music,
      questions: [
        { id: 'm1', type: 'text', label: '有愛情主題曲嗎？' },
        { id: 'm2', type: 'textarea', label: '平常都聽什麼歌？' },
        { id: 'm3', type: 'textarea', label: '婚禮的歌單？' },
        { id: 'm4', type: 'textarea', label: '您有沒有希望在婚禮中播放的特別影片或圖片？' },
        { id: 'm5', type: 'textarea', label: '婚禮中是否有某些特定的主題或顏色，您希望主持人參考？' },
        { id: 'm6', type: 'textarea', label: '您有沒有對婚禮流程中特定環節的時間長短有特別要求？' }
      ]
    },
    {
      id: 'other',
      title: '其他建議與期望',
      icon: MessageCircle,
      questions: [
        { id: 'o1', type: 'textarea', label: '對主持人有任何特殊的期望或要求嗎？' },
        { id: 'o2', type: 'textarea', label: '是否有其他您認為非常重要的細節，主持人需要注意的地方？' }
      ]
    }
  ];

  // --- States ---
  const [sections, setSections] = useState(initialSections);
  const [formData, setFormData] = useState({});
  const [submitted, setSubmitted] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // Auth & Admin States
  const [user, setUser] = useState(null);
  const [isAdminMode, setIsAdminMode] = useState(false); 
  const [isLoggedIn, setIsLoggedIn] = useState(false); 
  const [passwordInput, setPasswordInput] = useState('');
  const [loginError, setLoginError] = useState(false);
  
  // Admin Data States
  const [responses, setResponses] = useState([]);
  const [selectedResponse, setSelectedResponse] = useState(null);
  const [isLoadingData, setIsLoadingData] = useState(false);

  // --- Firebase Auth Effect (Standard Anonymous Auth) ---
  useEffect(() => {
    if (!auth) return; // 如果沒有設定 config，直接跳過

    const initAuth = async () => {
      try {
        // 標準的匿名登入
        await signInAnonymously(auth);
      } catch (error) {
        console.error("登入失敗 (請確認 Firebase Console Authentication 有開啟匿名登入):", error);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- Functions ---

  const handleInputChange = (questionId, value) => {
    setFormData(prev => ({ ...prev, [questionId]: value }));
  };

  const handleCheckboxChange = (questionId, option, checked) => {
    setFormData(prev => {
      const currentValues = prev[questionId] || [];
      const isOther = option.startsWith('其他') || option.startsWith('我想要補充');
      const otherPrefix = '我想要補充: ';
      
      let newValues;
      if (checked) {
        if (isOther) {
           const existingOther = currentValues.find(v => v.startsWith(otherPrefix) || v === option);
           if(existingOther) return prev; 
           newValues = [...currentValues, option];
        } else {
           newValues = [...currentValues, option];
        }
      } else {
        if (isOther) {
          newValues = currentValues.filter(v => !v.startsWith(otherPrefix) && !v.startsWith('其他'));
        } else {
          newValues = currentValues.filter(v => v !== option);
        }
      }
      return { ...prev, [questionId]: newValues };
    });
  };

  // Submit to Firebase
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) {
      alert("尚未連線到資料庫，請檢查您的 Firebase 設定或網路連線。");
      return;
    }
    
    setIsSubmitting(true);
    try {
      const dataToSave = {
        formData,
        submittedAt: Timestamp.now(),
        userId: user.uid,
        groomName: formData['b1'] || '未填寫',
        brideName: formData['b2'] || '未填寫',
        weddingDate: formData['b3'] || '未填寫'
      };

      // 改用標準的 collection 路徑，不再依賴 appId 變數
      await addDoc(collection(db, 'wedding_responses'), dataToSave);
      
      setSubmitted(true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
      console.error("Error submitting form: ", error);
      alert("提交失敗，請檢查 Firestore 是否已建立以及規則設定是否正確。");
    } finally {
      setIsSubmitting(false);
    }
  };

  // --- Admin Functions ---

  const handleAdminLogin = (e) => {
    e.preventDefault();
    if (passwordInput === '0903') {
      setIsLoggedIn(true);
      setLoginError(false);
      fetchResponses();
    } else {
      setLoginError(true);
    }
  };

  const fetchResponses = async () => {
    if (!user) return;
    setIsLoadingData(true);
    try {
      // 改用標準的 collection 路徑
      const querySnapshot = await getDocs(collection(db, 'wedding_responses'));
      const fetchedData = querySnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      
      fetchedData.sort((a, b) => b.submittedAt.seconds - a.submittedAt.seconds);
      
      setResponses(fetchedData);
    } catch (error) {
      console.error("Error fetching data: ", error);
      alert("讀取資料失敗，請確認 Firestore 權限規則。");
    } finally {
      setIsLoadingData(false);
    }
  };

  // Generate Word Document
  const exportToWord = (response) => {
    const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' 
      xmlns:w='urn:schemas-microsoft-com:office:word' 
      xmlns='http://www.w3.org/TR/REC-html40'>
      <head><meta charset='utf-8'><title>婚禮問卷資料</title>
      <style>body{font-family: "Microsoft JhengHei", sans-serif;}</style>
      </head><body>`;
    
    let body = `<h1>${response.groomName} & ${response.brideName} 婚禮主持問卷</h1>`;
    body += `<p>婚禮日期: ${response.weddingDate}</p><hr/>`;

    sections.forEach(section => {
      body += `<h3>${section.title}</h3>`;
      section.questions.forEach(q => {
        const answer = response.formData[q.id];
        let answerText = '未填寫';
        if (Array.isArray(answer)) {
          answerText = answer.join(', ');
        } else if (answer) {
          answerText = answer;
        }
        body += `<p><b>${q.label}</b><br/>${answerText}</p>`;
      });
      body += `<br/>`;
    });

    const footer = "</body></html>";
    const sourceHTML = header + body + footer;
    
    const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
    const fileDownload = document.createElement("a");
    document.body.appendChild(fileDownload);
    fileDownload.href = source;
    fileDownload.download = `${response.groomName}_${response.brideName}_婚禮問卷.doc`;
    fileDownload.click();
    document.body.removeChild(fileDownload);
  };

  // Print in New Window Function
  const printResponse = (response) => {
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      alert('請允許開啟彈出視窗以進行列印');
      return;
    }

    const htmlContent = `
      <!DOCTYPE html>
      <html>
        <head>
          <title>${response.groomName}_${response.brideName}_婚禮問卷</title>
          <style>
            body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; padding: 40px; color: #333; line-height: 1.6; }
            h1 { text-align: center; font-size: 26px; margin-bottom: 10px; font-weight: bold; }
            .meta { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
            .section { margin-bottom: 30px; page-break-inside: avoid; }
            .section-title { 
              font-size: 18px; 
              font-weight: bold; 
              color: #e11d48; 
              margin-bottom: 15px; 
              border-left: 5px solid #e11d48; 
              padding-left: 10px; 
              background: #fff1f2; 
              padding-top: 5px; 
              padding-bottom: 5px; 
            }
            .question-block { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
            .question-block:last-child { border-bottom: none; }
            .q-label { font-weight: bold; font-size: 15px; margin-bottom: 6px; color: #1f2937; }
            .q-answer { 
              padding: 8px 12px; 
              background: #f9fafb; 
              border-radius: 6px; 
              white-space: pre-wrap; 
              font-size: 14px; 
              color: #4b5563;
            }
            ul { margin: 0; padding-left: 20px; }
            li { margin-bottom: 4px; }
            @media print {
              body { padding: 0; -webkit-print-color-adjust: exact; }
              .section-title { -webkit-print-color-adjust: exact; }
            }
          </style>
        </head>
        <body>
          <h1>${response.groomName} & ${response.brideName} 婚禮主持問卷</h1>
          <div class="meta">
            婚禮日期: ${response.weddingDate} | 
            提交時間: ${response.submittedAt?.seconds ? new Date(response.submittedAt.seconds * 1000).toLocaleString('zh-TW') : '未知'}
          </div>

          ${sections.map(section => `
            <div class="section">
              <div class="section-title">${section.title}</div>
              ${section.questions.map(q => {
                const answer = response.formData[q.id];
                let displayAnswer = '<span style="color: #999; font-style: italic;">未填寫</span>';
                
                if (Array.isArray(answer) && answer.length > 0) {
                  displayAnswer = `<ul>${answer.map(a => `<li>${a}</li>`).join('')}</ul>`;
                } else if (answer) {
                  displayAnswer = answer;
                }
                
                return `
                  <div class="question-block">
                    <div class="q-label">${q.label}</div>
                    <div class="q-answer">${displayAnswer}</div>
                  </div>
                `;
              }).join('')}
            </div>
          `).join('')}
          <script>
            // 等待內容載入後自動開啟列印視窗
            window.onload = () => { setTimeout(() => window.print(), 500); };
          </script>
        </body>
      </html>
    `;

    printWindow.document.write(htmlContent);
    printWindow.document.close();
  };

  // --- Components ---
  // ChoiceGroup component remains same
  const ChoiceGroup = ({ question, readOnlyValue = null }) => {
    const currentValues = readOnlyValue !== null ? readOnlyValue : (formData[question.id] || (question.type === 'checkbox' ? [] : ''));
    const isMultiple = question.type === 'checkbox';

    return (
      <div className="space-y-2">
        {question.options.map((option, optIdx) => {
          const isOtherOption = option.includes('其他') || option.includes('我想要補充');
          const displayOptionText = isOtherOption ? '我想要補充...' : option;
          const otherPrefix = '我想要補充: ';
          
          let isSelected;
          let otherTextValue = '';

          if (isMultiple) {
            if (isOtherOption) {
              const found = Array.isArray(currentValues) ? currentValues.find(v => v.startsWith(otherPrefix) || v === option) : null;
              isSelected = !!found;
              otherTextValue = found ? found.replace(otherPrefix, '') : '';
              if(otherTextValue === option) otherTextValue = ''; 
            } else {
              isSelected = Array.isArray(currentValues) && currentValues.includes(option);
            }
          } else {
            if (isOtherOption) {
              isSelected = (typeof currentValues === 'string') && (currentValues.startsWith(otherPrefix) || currentValues === option);
              otherTextValue = isSelected ? currentValues.replace(otherPrefix, '') : '';
            } else {
              isSelected = currentValues === option;
            }
          }

          return (
            <div key={optIdx}>
              <label className={`flex items-center space-x-3 p-2 rounded cursor-pointer transition-colors ${isSelected ? 'bg-rose-50 border-rose-200' : 'hover:bg-gray-50'}`}>
                <input
                  type={isMultiple ? "checkbox" : "radio"}
                  name={question.id}
                  value={option}
                  checked={isSelected}
                  className={`w-4 h-4 text-rose-600 focus:ring-rose-500 border-gray-300 ${!isMultiple ? 'rounded-full' : 'rounded'}`}
                  onChange={(e) => {
                    if (isMultiple) {
                      handleCheckboxChange(question.id, option, e.target.checked);
                    } else {
                      handleInputChange(question.id, option);
                    }
                  }}
                />
                <span className="text-gray-700">{displayOptionText}</span>
              </label>

              {isOtherOption && isSelected && (
                <div className="ml-7 mt-2 pl-2 border-l-2 border-rose-200 animate-fadeIn">
                  <input
                    type="text"
                    className="w-full p-2 bg-rose-50/30 border-b border-rose-300 outline-none text-gray-700 placeholder-gray-400 text-sm rounded-r focus:border-rose-500"
                    placeholder="請在此輸入補充內容..."
                    value={otherTextValue}
                    autoFocus
                    onChange={(e) => {
                      const val = `${otherPrefix}${e.target.value}`;
                      if (isMultiple) {
                        setFormData(prev => {
                          const oldArr = prev[question.id] || [];
                          const filtered = oldArr.filter(v => !v.startsWith(otherPrefix) && !v.startsWith('其他'));
                          return { ...prev, [question.id]: [...filtered, val] };
                        });
                      } else {
                        handleInputChange(question.id, val);
                      }
                    }}
                  />
                </div>
              )}
            </div>
          );
        })}
      </div>
    );
  };

  // --- Views ---

  // 1. Success View
  if (submitted) {
    return (
      <div className="min-h-screen bg-rose-50 flex items-center justify-center p-4 font-sans">
        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full text-center">
          <div className="mb-6 flex justify-center">
            <div className="bg-green-100 p-4 rounded-full">
              <CheckCircle size={64} className="text-green-600" />
            </div>
          </div>
          <h2 className="text-3xl font-serif font-bold text-gray-800 mb-4">問卷已送出！</h2>
          <p className="text-gray-600 mb-8">感謝您的填寫，我們會盡快與您聯繫。</p>
          <button 
            onClick={() => {
              setSubmitted(false);
              setFormData({});
            }}
            className="bg-gray-100 text-gray-600 px-6 py-3 rounded-full hover:bg-gray-200 transition-colors"
          >
            返回首頁
          </button>
        </div>
      </div>
    );
  }

  // 2. Admin Login & Dashboard
  if (isAdminMode) {
    // A. Login Screen
    if (!isLoggedIn) {
      return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 font-sans">
          <div className="bg-white p-8 rounded-xl shadow-lg max-w-sm w-full">
            <div className="flex justify-center mb-4 text-gray-700">
              <Lock size={48} />
            </div>
            <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">後台管理登入</h2>
            <form onSubmit={handleAdminLogin}>
              <div className="mb-4">
                <input
                  type="password"
                  value={passwordInput}
                  onChange={(e) => setPasswordInput(e.target.value)}
                  placeholder="請輸入管理員密碼"
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 outline-none"
                  autoFocus
                />
              </div>
              {loginError && <p className="text-red-500 text-sm mb-4 text-center">密碼錯誤，請重試。</p>}
              <button 
                type="submit"
                className="w-full bg-gray-800 text-white py-3 rounded-lg hover:bg-gray-900 transition-colors font-bold"
              >
                登入
              </button>
              <button 
                type="button"
                onClick={() => setIsAdminMode(false)}
                className="w-full mt-3 text-gray-500 py-2 text-sm hover:text-gray-700"
              >
                返回問卷首頁
              </button>
            </form>
          </div>
        </div>
      );
    }

    // B. Response Detail View
    if (selectedResponse) {
      return (
        <div className="min-h-screen bg-gray-100 font-sans">
          {/* Header */}
          <div className="bg-white shadow border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
            <button 
              onClick={() => setSelectedResponse(null)}
              className="flex items-center text-gray-600 hover:text-gray-900"
            >
              <ChevronLeft size={20} /> 返回列表
            </button>
            <div className="flex gap-3">
              <button 
                onClick={() => exportToWord(selectedResponse)}
                className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              >
                <FileText size={18} /> 匯出 Word
              </button>
              <button 
                onClick={() => printResponse(selectedResponse)}
                className="flex items-center gap-2 bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900"
              >
                <Printer size={18} /> 列印 / 下載 PDF
              </button>
            </div>
          </div>

          <div className="max-w-4xl mx-auto p-8 bg-white my-8 shadow-lg">
            <div className="text-center border-b-2 border-gray-800 pb-6 mb-8">
              <h1 className="text-3xl font-bold text-gray-900 mb-2">婚禮主持問卷資料</h1>
              <p className="text-gray-600">
                提交時間: {selectedResponse.submittedAt?.seconds ? new Date(selectedResponse.submittedAt.seconds * 1000).toLocaleString('zh-TW') : '未知'}
              </p>
            </div>

            <div className="space-y-8">
              {sections.map(section => (
                <div key={section.id}>
                  <h3 className="text-xl font-bold text-gray-800 border-l-4 border-rose-500 pl-3 mb-4 bg-gray-50 py-1">
                    {section.title}
                  </h3>
                  <div className="grid gap-4 pl-4">
                    {section.questions.map(q => {
                      const answer = selectedResponse.formData[q.id];
                      let displayAnswer = <span className="text-gray-400 italic">未填寫</span>;
                      
                      if (Array.isArray(answer) && answer.length > 0) {
                        displayAnswer = (
                          <ul className="list-disc list-inside text-gray-800 font-medium">
                            {answer.map((a, i) => <li key={i}>{a}</li>)}
                          </ul>
                        );
                      } else if (answer) {
                        displayAnswer = <p className="text-gray-800 font-medium whitespace-pre-wrap">{answer}</p>;
                      }

                      return (
                        <div key={q.id} className="mb-2">
                          <p className="text-sm text-gray-500 mb-1">{q.label}</p>
                          <div className="p-2 bg-gray-50 rounded border border-gray-100">
                            {displayAnswer}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // C. Dashboard List View
    return (
      <div className="min-h-screen bg-gray-50 font-sans">
        <nav className="bg-white shadow px-6 py-4 flex justify-between items-center">
          <div className="flex items-center gap-2">
             <ClipboardList className="text-rose-500" />
             <h1 className="text-xl font-bold text-gray-800">婚禮問卷後台管理</h1>
          </div>
          <div className="flex items-center gap-4">
            <button onClick={fetchResponses} className="text-sm text-blue-600 hover:underline">重新整理</button>
            <button 
              onClick={() => {
                setIsLoggedIn(false);
                setPasswordInput('');
                setIsAdminMode(false);
              }}
              className="flex items-center gap-1 text-gray-500 hover:text-red-500 transition-colors"
            >
              <LogOut size={18} /> 登出
            </button>
          </div>
        </nav>

        <div className="max-w-5xl mx-auto p-6">
          {isLoadingData ? (
            <div className="text-center py-12 text-gray-500">載入資料中...</div>
          ) : responses.length === 0 ? (
            <div className="bg-white rounded-xl shadow p-12 text-center">
              <div className="flex justify-center mb-4">
                <FileText size={48} className="text-gray-300" />
              </div>
              <p className="text-gray-500 text-lg">目前還沒有任何問卷回覆。</p>
            </div>
          ) : (
            <div className="grid gap-4">
              {responses.map(response => (
                <div 
                  key={response.id} 
                  onClick={() => setSelectedResponse(response)}
                  className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-transparent hover:border-rose-200 group"
                >
                  <div className="flex justify-between items-center">
                    <div>
                      <h3 className="text-lg font-bold text-gray-800 group-hover:text-rose-600 transition-colors">
                        {response.groomName} & {response.brideName}
                      </h3>
                      <div className="flex items-center gap-4 mt-2 text-sm text-gray-500">
                        <span className="flex items-center gap-1"><Calendar size={14}/> 婚禮: {response.weddingDate}</span>
                        <span className="flex items-center gap-1"><Download size={14}/> 提交於: {response.submittedAt?.seconds ? new Date(response.submittedAt.seconds * 1000).toLocaleDateString() : '未知'}</span>
                      </div>
                    </div>
                    <ChevronLeft size={24} className="text-gray-300 transform rotate-180" />
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  // 3. Public Form View (Default)
  return (
    <div className="min-h-screen bg-rose-50/50 py-12 px-4 font-sans selection:bg-rose-200">
      <div className="max-w-3xl mx-auto relative">
        {/* Only checking if firebaseConfig is placeholder to show warning */}
        {firebaseConfig.apiKey === "請替換成您的_API_KEY" && (
            <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
                <p className="font-bold">設定提醒</p>
                <p>請記得修改程式碼中的 firebaseConfig，填入您自己的 Firebase 專案設定，否則無法送出問卷。</p>
            </div>
        )}

        {/* Header */}
        <div className="bg-white rounded-t-2xl shadow-lg border-t-8 border-rose-400 p-8 mb-6 text-center relative">
          <div className="flex justify-center mb-4">
            <Sparkles className="text-rose-400" size={40} />
          </div>
          <h1 className="text-3xl md:text-4xl font-serif font-bold text-gray-800 mb-4">
            新人婚禮主持風格與個人細節問卷
          </h1>
          <p className="text-gray-600 leading-relaxed">
            親愛的新人您好，為了讓您的婚禮更加完美，請協助我們填寫以下問卷。
          </p>
        </div>

        <form onSubmit={handleSubmit}>
          
          {sections.map((section, sIdx) => (
            <div key={section.id} className="bg-white rounded-xl shadow-md p-6 mb-6 transition-all hover:shadow-lg">
              {/* Section Title */}
              <div className="flex items-center gap-3 mb-6 mt-2 border-b border-rose-200 pb-2">
                <div className="p-2 bg-rose-100 rounded-full text-rose-600">
                  <section.icon size={24} />
                </div>
                <h2 className="text-xl font-serif font-bold text-gray-800">{section.title}</h2>
              </div>

              {/* Questions Loop */}
              <div className="space-y-6">
                {section.questions.map((q, qIdx) => (
                  <div key={q.id} className="relative group p-4 rounded-lg border border-transparent bg-white">
                    {/* 題目 Label */}
                    <div className="mb-3">
                      <label className="block text-gray-700 font-medium text-lg">
                        {q.label}
                        {q.type === 'checkbox' && <span className="text-sm text-rose-500 ml-2 font-normal">(可複選)</span>}
                      </label>
                    </div>

                    {/* 題目 Content */}
                    <div>
                      {q.type === 'text' || q.type === 'date' ? (
                        <input
                          type={q.type}
                          className="w-full p-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-rose-200 outline-none bg-white transition-all"
                          onChange={(e) => handleInputChange(q.id, e.target.value)}
                        />
                      ) : q.type === 'textarea' ? (
                        <textarea
                          className="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-rose-200 outline-none min-h-[100px] transition-all"
                          placeholder="請在此輸入..."
                          onChange={(e) => handleInputChange(q.id, e.target.value)}
                        />
                      ) : (
                         <ChoiceGroup question={q} />
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}

          {/* Submit Button */}
          <div className="mt-12 flex flex-col items-center justify-center pb-12 gap-6">
            <button 
              type="submit"
              disabled={isSubmitting}
              className={`flex items-center gap-2 bg-rose-500 text-white font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 ${isSubmitting ? 'opacity-70 cursor-not-allowed' : 'hover:bg-rose-600'}`}
            >
              {isSubmitting ? '提交中...' : <><Send size={20} /> 提交問卷</>}
            </button>

            {/* Admin Login Link */}
            <button
              type="button"
              onClick={() => setIsAdminMode(true)}
              className="text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1"
            >
              <Lock size={12} /> 後台管理
            </button>
          </div>

        </form>
      </div>
    </div>
  );
};

export default WeddingSurveyForm;
